<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Заработок на рекламе — Monetag</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Monetag SDK -->
  <script src="//libtl.com/sdk.js"
          data-zone="9687002"
          data-sdk="show_9687002"></script>

  <style>
    body { font-family: sans-serif; background: #f5f7fa; padding: 20px; }
    .container {
      max-width: 480px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.05);
      text-align: center;
    }
    h1 { font-size: 1.4rem; margin-bottom: 10px; }
    p { margin: 6px 0; }
    button {
      background: #1f8ef1;
      color: #fff;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    #status { margin-top: 15px; color: #555; font-size: 0.95rem; }
  </style>
</head>
<body>
<div class="container">
  <h1>Смотри рекламу — зарабатывай</h1>
  <p>Баланс: <span id="balance">0.00</span> монет</p>
  <p>Осталось показов сегодня: <span id="remaining">30</span></p>
  <button id="watch" disabled>Загрузка рекламы...</button>
  <div id="status"></div>
</div>

<script>
  const MAX_ADS_PER_DAY = 30;
  const WAIT_SECONDS = 20;
  const COOKIE_DAYS = 7;

  const tg = window.Telegram?.WebApp;
  if (tg) tg.expand();

  // ==================== Cookie helpers ====================
  function setCookie(name, value, days) {
    const d = new Date();
    d.setTime(d.getTime() + (days*24*60*60*1000));
    document.cookie = `${name}=${value};expires=${d.toUTCString()};path=/`;
  }
  function getCookie(name) {
    const cname = name + "=";
    const decodedCookie = decodeURIComponent(document.cookie);
    const ca = decodedCookie.split(';');
    for(let i = 0; i < ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) === ' ') c = c.substring(1);
      if (c.indexOf(cname) === 0) {
        return c.substring(cname.length, c.length);
      }
    }
    return "";
  }

  // ==================== State load ====================
  function todayKey() {
    const now = new Date();
    return `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
  }

  let balance = parseFloat(getCookie('balance') || '0');
  let lastDate = getCookie('ads_date') || todayKey();
  let adsToday = parseInt(getCookie('ads_today') || '0');

  // Reset if new day
  if (lastDate !== todayKey()) {
    adsToday = 0;
    lastDate = todayKey();
    setCookie('ads_date', lastDate, COOKIE_DAYS);
    setCookie('ads_today', adsToday, COOKIE_DAYS);
  }

  function updateUI() {
    document.getElementById('balance').textContent = balance.toFixed(2);
    document.getElementById('remaining').textContent = Math.max(0, MAX_ADS_PER_DAY - adsToday);
  }

  updateUI();

  const watchBtn = document.getElementById('watch');
  const statusEl = document.getElementById('status');

  // Wait until SDK loaded
  const sdkCheck = setInterval(() => {
    if (typeof window.show_9687002 === 'function') {
      clearInterval(sdkCheck);
      if (adsToday < MAX_ADS_PER_DAY) {
        watchBtn.disabled = false;
        watchBtn.textContent = '▶ Смотреть рекламу';
      } else {
        watchBtn.disabled = true;
        watchBtn.textContent = 'Лимит на сегодня исчерпан';
      }
    }
  }, 300);

  let cooldown = false;

  watchBtn.addEventListener('click', () => {
    if (cooldown) {
      statusEl.textContent = `Подождите ${WAIT_SECONDS} секунд перед следующим показом.`;
      return;
    }
    if (adsToday >= MAX_ADS_PER_DAY) {
      statusEl.textContent = 'Лимит показов на сегодня достигнут.';
      return;
    }

    statusEl.textContent = 'Загружаем рекламу...';
    cooldown = true;
    watchBtn.disabled = true;

    show_9687002()
      .then(result => {
        if (result && result.reward_event_type === 'valued') {
          balance += 0.05;
          adsToday += 1;
          setCookie('balance', balance, COOKIE_DAYS);
          setCookie('ads_today', adsToday, COOKIE_DAYS);
          setCookie('ads_date', todayKey(), COOKIE_DAYS);
          updateUI();
          statusEl.textContent = 'Реклама просмотрена! +0.05 монет.';
        } else {
          statusEl.textContent = 'Реклама показана, но без награды.';
        }
      })
      .catch(err => {
        console.error(err);
        statusEl.textContent = 'Ошибка показа рекламы: ' + err.message;
      })
      .finally(() => {
        setTimeout(() => {
          cooldown = false;
          if (adsToday < MAX_ADS_PER_DAY) {
            watchBtn.disabled = false;
          } else {
            watchBtn.textContent = 'Лимит на сегодня исчерпан';
          }
        }, WAIT_SECONDS * 1000);
      });
  });
</script>
</body>
</html>
