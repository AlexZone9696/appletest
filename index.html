<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>App — Staking / Tasks / Referrals</title>

<!-- Telegram WebApp (если открывают из Telegram) -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Monetag SDK (zone 9687002) -->
<script src="//libtl.com/sdk.js" data-zone="9687002" data-sdk="show_9687002"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  :root{
    --green:#2ecc71;
    --accent:#1f8ef1;
    --card-bg:#fff;
    --bg:#f5f7fa;
    --muted:#6b7280;
    --maxw:420px;
  }
  body{ margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); padding-bottom:88px; color:#111; }
  .header{ background:var(--green); color:#fff; padding:14px 16px; display:flex; gap:12px; align-items:center; }
  .avatar{ width:44px; height:44px; border-radius:10px; background:#e6f6ea; display:flex; align-items:center; justify-content:center; color:var(--green); font-weight:700; }
  .userinfo{ flex:1; }
  .username{ font-weight:700; }
  .balance{ font-size:0.9rem; opacity:0.95; margin-top:2px; }

  main{ max-width:var(--maxw); margin:18px auto; padding:0 12px; }

  .tabs{ display:flex; gap:8px; justify-content:center; margin-bottom:12px; }
  .tab-btn{ background:transparent; border:0; padding:8px 12px; border-radius:999px; cursor:pointer; color:var(--muted); font-weight:600; }
  .tab-btn.active{ background:rgba(46,204,113,0.12); color:var(--green); box-shadow:0 6px 18px rgba(46,204,113,0.08); }

  .card{ background:var(--card-bg); border-radius:12px; padding:14px; box-shadow:0 4px 18px rgba(16,24,40,0.05); margin-bottom:12px; }

  /* progress */
  .row{ display:flex; justify-content:space-between; align-items:center; }
  .muted{ color:var(--muted); font-size:0.92rem; }
  .progress-bar{ height:10px; background:#eee; border-radius:999px; overflow:hidden; margin-top:10px; }
  .progress{ height:100%; background:var(--green); width:0%; transition:width .4s ease; }

  .primary-btn{ display:block; width:100%; padding:12px; background:var(--accent); color:#fff; border:0; border-radius:10px; font-weight:700; font-size:1rem; cursor:pointer; margin-top:12px; }
  .primary-btn:disabled{ opacity:0.6; cursor:not-allowed; }

  /* daily tasks list */
  .task-item{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:8px 0; }
  .task-title{ font-weight:600; }
  .task-sub{ color:var(--green); font-weight:700; margin-top:3px; font-size:0.9rem; }
  .task-actions{ display:flex; gap:8px; align-items:center; }
  .btn-join{ background:#fff; border:1px solid var(--green); color:var(--green); padding:8px 10px; border-radius:8px; text-decoration:none; display:inline-flex; gap:8px; align-items:center; }
  .btn-verify{ background:#cfd8dc; border:0; color:#fff; padding:8px 10px; border-radius:8px; cursor:not-allowed; }

  /* staking */
  .grid{ display:grid; gap:10px; }
  input[type=number], select { width:100%; padding:10px; border-radius:8px; border:1px solid #e6e9ee; font-size:0.95rem; }

  /* referrals fixed button */
  .refer-fixed{ position:fixed; right:16px; bottom:96px; background:var(--green); color:#fff; border:0; padding:12px 16px; border-radius:999px; display:flex; gap:8px; align-items:center; box-shadow:0 8px 26px rgba(46,204,113,0.18); z-index:40; cursor:pointer; }

  /* toast */
  .toast{ position:fixed; top:18px; right:18px; background:var(--green); color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 10px 30px rgba(10,20,30,0.12); transform:translateY(-8px); opacity:0; transition:all .32s ease; z-index:60; }
  .toast.show{ opacity:1; transform:translateY(0); }

  /* bottom nav */
  .bottom-nav{ position:fixed; bottom:0; left:0; right:0; height:64px; background:#fff; display:flex; justify-content:space-around; align-items:center; border-top:1px solid #eee; box-shadow:0 -6px 22px rgba(10,20,30,0.04); z-index:30; }
  .nav-item{ flex:1; text-align:center; color:var(--muted); font-size:12px; }
  .nav-item i{ font-size:18px; display:block; margin-bottom:4px; }
  .nav-item.active{ color:var(--green); font-weight:700; }

  /* small screen tweaks */
  @media (max-width:420px){
    :root{ --maxw:98%; }
    .header{ padding:12px; }
  }
</style>
</head>
<body>

<!-- header -->
<div class="header">
  <div class="avatar" id="avatar">DW</div>
  <div class="userinfo">
    <div class="username" id="ui_name">David Wilson</div>
    <div class="balance">Баланс: <span id="ui_balance">0.00</span> VET</div>
  </div>
</div>

<main>
  <!-- tabs -->
  <div class="tabs" role="tablist">
    <button class="tab-btn active" data-tab="staking">Staking</button>
    <button class="tab-btn" data-tab="tasks">Tasks</button>
    <button class="tab-btn" data-tab="referrals">Referrals</button>
  </div>

  <!-- STAKING TAB -->
  <section id="staking" class="tab-panel">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><strong>Staking Calculator</strong><div class="muted" style="font-size:0.9rem;margin-top:4px;">Calculate estimated profit</div></div>
        <div class="muted">APR<input id="apr" type="number" value="12" style="width:64px;margin-left:8px;display:inline-block;padding:6px;border-radius:6px;border:1px solid #eee;"></div>
      </div>

      <div class="grid" style="margin-top:12px;">
        <label>Amount to stake (VET)</label>
        <input id="stake_amt" type="number" min="0" step="0.01" value="100">

        <label>Period (months)</label>
        <select id="stake_period">
          <option value="1">1 month</option>
          <option value="3">3 months</option>
          <option value="6">6 months</option>
          <option value="12">12 months</option>
        </select>

        <div style="display:flex; gap:8px;">
          <button id="calcBtn" class="primary-btn">Calculate</button>
          <button id="stakeBtn" class="primary-btn" style="background:var(--green);border-radius:10px;">Stake</button>
        </div>

        <div id="stakeResult" class="muted" style="margin-top:6px;"></div>
      </div>
    </div>
  </section>

  <!-- TASKS TAB -->
  <section id="tasks" class="tab-panel" style="display:none;">
    <!-- Ad card -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <strong>Watch Ads</strong>
          <div class="muted" style="font-size:0.9rem;margin-top:4px;">Earn by watching rewarded ads (Monetag)</div>
        </div>
        <div style="text-align:right;">
          <div class="muted">Daily limit</div>
          <div style="font-weight:700" id="adLimit">30</div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="row"><div class="muted">Completed</div><div id="adCompleted">0</div></div>
        <div class="row"><div class="muted">Remaining</div><div id="adRemaining">30</div></div>
        <div class="progress-bar"><div id="adProgress" class="progress"></div></div>
        <button id="adWatchBtn" class="primary-btn" style="margin-top:12px;" disabled>Loading ad...</button>
        <div class="muted" id="adStatus" style="margin-top:8px;"></div>
      </div>
    </div>

    <!-- Daily tasks list -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><strong>Daily Tasks</strong><div class="muted">Subscribe to channels / groups</div></div>
        <div class="muted">1 time each</div>
      </div>

      <div style="margin-top:12px; display:flex;flex-direction:column; gap:8px;">
        <!-- Task 1 -->
        <div class="task-item" data-taskid="t1">
          <div>
            <div class="task-title">Crypto News Channel</div>
            <div class="task-sub">Reward: VET 2.00</div>
          </div>
          <div class="task-actions">
            <a class="btn-join" href="https://t.me/cryptonews" target="_blank"><i class="fa-brands fa-telegram"></i> Join</a>
            <button class="btn-verify" disabled>Verify</button>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid #eee;margin:0">

        <!-- Task 2 -->
        <div class="task-item" data-taskid="t2">
          <div>
            <div class="task-title">Airdrop Hunters</div>
            <div class="task-sub">Reward: VET 3.00</div>
          </div>
          <div class="task-actions">
            <a class="btn-join" href="https://t.me/airdrophunters" target="_blank"><i class="fa-brands fa-telegram"></i> Join</a>
            <button class="btn-verify" disabled>Verify</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- REFERRALS TAB -->
  <section id="referrals" class="tab-panel" style="display:none;">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <strong>Your Referral</strong>
          <div class="muted" style="margin-top:6px;">Invite friends — they open bot with <code>startapp</code> param</div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="muted">Your ID</div>
        <div style="font-weight:700;margin-top:6px;" id="yourId">-</div>

        <div style="margin-top:10px;" class="muted">Share this link</div>
        <div style="margin-top:8px;display:flex;gap:8px;">
          <input id="refLink" readonly style="flex:1;padding:10px;border-radius:8px;border:1px solid #eee;background:#fafafa"/>
          <button id="copyRef" class="primary-btn" style="width:120px;padding:10px;">Copy</button>
        </div>

        <div style="margin-top:10px;" class="muted">Referred by</div>
        <div style="margin-top:6px;font-weight:700;" id="referredBy">—</div>
      </div>
    </div>
  </section>
</main>

<!-- toast -->
<div id="toast" class="toast">Оплата получена</div>

<!-- refer fixed -->
<button class="refer-fixed" id="openRef"><i class="fa-solid fa-users"></i> Refer & Earn</button>

<!-- bottom nav -->
<nav class="bottom-nav" aria-label="Bottom navigation">
  <div class="nav-item active" data-target="staking"><i class="fa-solid fa-house"></i>Home</div>
  <div class="nav-item" data-target="tasks"><i class="fa-solid fa-coins"></i>Earn</div>
  <div class="nav-item" data-target="referrals"><i class="fa-solid fa-share-nodes"></i>Referrals</div>
  <div class="nav-item" data-target="profile"><i class="fa-solid fa-user"></i>Profile</div>
</nav>

<script>
/* -----------------------
   Utilities: cookies, date-key
   ----------------------- */
function setCookie(name, value, days=7) {
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  document.cookie = `${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/`;
}
function getCookie(name) {
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? decodeURIComponent(m.pop()) : null;
}
function todayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}
function showToast(msg, ms=3000) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), ms);
}

/* -----------------------
   Init basic user/referral state
   ----------------------- */
let balance = parseFloat(getCookie('balance') || '0');
let userId = getCookie('user_id');
if (!userId) {
  // generate short id for this client (used for referral link)
  userId = 'u' + Math.random().toString(36).slice(2,9);
  setCookie('user_id', userId, 365);
}
document.getElementById('yourId').textContent = userId;
document.getElementById('refLink').value = `https://t.me/YOUR_BOT?startapp=${userId}`; // replace YOUR_BOT with bot username
// accept referrer from URL param startapp or from Telegram WebApp initData (if present)
function readStartAppFromUrl() {
  try {
    const url = new URL(window.location.href);
    return url.searchParams.get('startapp') || url.searchParams.get('start');
  } catch(e){ return null; }
}
let refFromUrl = readStartAppFromUrl();
let tgInitRef = null;
try {
  const tg = window.Telegram && window.Telegram.WebApp;
  if (tg && tg.initDataUnsafe && tg.initDataUnsafe.start_param) tgInitRef = tg.initDataUnsafe.start_param;
} catch(e){}
let referrer = getCookie('referrer') || (refFromUrl || tgInitRef) || null;
if (referrer && referrer !== userId) {
  setCookie('referrer', referrer, 365);
}
document.getElementById('referredBy').textContent = referrer || '—';
document.getElementById('ui_balance').textContent = balance.toFixed(2);

/* -----------------------
   Tabs and navigation
   ----------------------- */
const tabBtns = document.querySelectorAll('.tab-btn');
const panels = { staking: document.getElementById('staking'), tasks: document.getElementById('tasks'), referrals: document.getElementById('referrals') };
tabBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    tabBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    for(const k in panels) panels[k].style.display = (k === tab ? '' : 'none');
    // sync bottom nav active
    document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.getAttribute('data-target') === (tab === 'staking' ? 'staking' : tab)));
  });
});
document.querySelectorAll('.nav-item').forEach(it => {
  it.addEventListener('click', () => {
    const target = it.dataset.target;
    // map bottom nav to tab
    if (target === 'profile') {
      // profile opens referrals tab for now
      document.querySelector('.tab-btn[data-tab="referrals"]').click();
    } else if (target === 'tasks') {
      document.querySelector('.tab-btn[data-tab="tasks"]').click();
    } else if (target === 'staking' || target === 'referrals') {
      document.querySelector(`.tab-btn[data-tab="${target}"]`).click();
    }
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    it.classList.add('active');
  });
});

/* -----------------------
   Staking calculator
   ----------------------- */
document.getElementById('calcBtn').addEventListener('click', () => {
  const amt = parseFloat(document.getElementById('stake_amt').value) || 0;
  const months = parseInt(document.getElementById('stake_period').value, 10);
  const apr = parseFloat(document.getElementById('apr').value) || 0;
  // simple interest approximation: profit = amt * (apr/100) * (months/12)
  const profit = amt * (apr/100) * (months/12);
  document.getElementById('stakeResult').textContent = `Приблизительный доход через ${months} мес: ${profit.toFixed(4)} VET`;
});
document.getElementById('stakeBtn').addEventListener('click', () => {
  showToast('Staking created (simulated)');
});

/* -----------------------
   Ads logic (Monetag) + limits
   ----------------------- */
const MAX_ADS_PER_DAY = 30;
const REWARD_PER_AD = 0.05; // change as you like
const COOLDOWN_MS = 20*1000;

function readAdState() {
  const date = getCookie('ads_date') || todayKey();
  let count = parseInt(getCookie('ads_today') || '0', 10);
  let last = parseInt(getCookie('ads_last') || '0', 10);
  if (date !== todayKey()) { // reset daily
    count = 0;
    setCookie('ads_date', todayKey(), 7);
    setCookie('ads_today', count, 7);
    setCookie('ads_last', 0, 7);
  }
  return { count, last };
}
function writeAdState(count, last) {
  setCookie('ads_today', count, 7);
  setCookie('ads_last', last, 7);
  setCookie('ads_date', todayKey(), 7);
}
function updateAdUI() {
  const st = readAdState();
  document.getElementById('adCompleted').textContent = st.count;
  document.getElementById('adRemaining').textContent = Math.max(0, MAX_ADS_PER_DAY - st.count);
  document.getElementById('adProgress').style.width = (st.count / MAX_ADS_PER_DAY * 100) + '%';
  document.getElementById('ui_balance').textContent = balance.toFixed(4);
}
updateAdUI();

// Wait for Monetag SDK to appear
const adBtn = document.getElementById('adWatchBtn');
let sdkPoll = setInterval(() => {
  if (typeof window.show_9687002 === 'function') {
    clearInterval(sdkPoll);
    adBtn.disabled = false;
    adBtn.textContent = '▶ Watch Ad';
  }
}, 300);

adBtn.addEventListener('click', async () => {
  const st = readAdState();
  const now = Date.now();
  if (st.count >= MAX_ADS_PER_DAY) {
    alert('Дневной лимит показов достигнут.');
    return;
  }
  if (now - st.last < COOLDOWN_MS) {
    const sleft = Math.ceil((COOLDOWN_MS - (now - st.last))/1000);
    alert(`Подождите ещё ${sleft} сек.`);
    return;
  }
  if (typeof window.show_9687002 !== 'function') {
    alert('Реклама ещё не загрузилась.');
    return;
  }

  document.getElementById('adStatus').textContent = 'Loading ad...';
  adBtn.disabled = true;

  try {
    // call SDK; pass ymid that includes local userId to track
    const ymid = `${userId}-${Date.now()}`;
    const res = await window.show_9687002({ ymid, telegram_id: (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) ? window.Telegram.WebApp.initDataUnsafe.user.id : '' });
    // SDK may return object; check reward_event_type
    if (res && res.reward_event_type === 'valued') {
      st.count += 1;
      st.last = Date.now();
      balance = parseFloat((balance + REWARD_PER_AD).toFixed(6));
      writeAdState(st.count, st.last);
      setCookie('balance', balance, 30);
      showToast(`Оплата получена: +${REWARD_PER_AD} VET`);
    } else {
      document.getElementById('adStatus').textContent = 'Ad shown but not monetized.';
    }
  } catch (err) {
    console.error('Ad error', err);
    alert('Ошибка показа рекламы: ' + (err && err.message ? err.message : err));
  } finally {
    updateAdUI();
    // set cooldown UI
    setTimeout(() => {
      // enable button only if user still has remaining ads
      const st2 = readAdState();
      if (st2.count < MAX_ADS_PER_DAY) adBtn.disabled = false;
      document.getElementById('adStatus').textContent = '';
    }, COOLDOWN_MS);
  }
});

/* -----------------------
   Daily tasks Join->Verify (client-side simulated)
   ----------------------- */
function taskDoneKey(taskId) {
  return `task_${taskId}_done_${todayKey()}`;
}
document.querySelectorAll('.task-item').forEach(item => {
  const taskId = item.dataset.taskid;
  const join = item.querySelector('.btn-join');
  const verify = item.querySelector('.btn-verify');
  const rewardText = item.querySelector('.task-sub').textContent || '';
  const reward = parseFloat((rewardText.match(/[\d.]+/) || [0])[0]);

  // if task already done today -> disable verify
  if (getCookie(taskDoneKey(taskId))) {
    verify.disabled = true;
    verify.style.opacity = 0.6;
    verify.style.cursor = 'not-allowed';
    verify.textContent = 'Done';
  }

  join.addEventListener('click', () => {
    // when user clicks join we enable verify button visually
    verify.disabled = false;
    verify.style.background = 'var(--green)';
    verify.style.cursor = 'pointer';
    verify.style.color = '#fff';
  });

  verify.addEventListener('click', () => {
    if (verify.disabled) return;
    // mark as done today and pay reward
    setCookie(taskDoneKey(taskId), '1', 1);
    balance = parseFloat((balance + (isNaN(reward) ? 0 : reward)).toFixed(6));
    setCookie('balance', balance, 30);
    updateAdUI();
    verify.disabled = true;
    verify.style.opacity = 0.6;
    verify.style.cursor = 'not-allowed';
    verify.textContent = 'Done';
    showToast(`Подписка подтверждена: +${reward} VET`);
  });
});

/* -----------------------
   Referral interactions
   ----------------------- */
document.getElementById('copyRef').addEventListener('click', async () => {
  const link = document.getElementById('refLink').value;
  try {
    await navigator.clipboard.writeText(link);
    showToast('Ссылка скопирована');
  } catch (e) {
    alert('Невозможно скопировать — скопируйте вручную: ' + link);
  }
});
document.getElementById('openRef').addEventListener('click', () => {
  // open referrals tab
  document.querySelector('.tab-btn[data-tab="referrals"]').click();
});

/* -----------------------
   Persist state & UI helpers
   ----------------------- */
function updateAdUIandBalance() {
  updateAdUI();
  document.getElementById('ui_balance').textContent = balance.toFixed(4);
}
updateAdUIandBalance();

/* Ensure daily reset for tasks and ads on navigation */
window.addEventListener('focus', () => {
  // reset daily counters if day changed
  // calling readAdState will reset cookies if needed
  readAdState(); 
  document.querySelectorAll('.task-item').forEach(item => {
    const key = taskDoneKey(item.dataset.taskid);
    if (getCookie(key)) {
      const v = item.querySelector('.btn-verify');
      v.disabled = true; v.textContent='Done'; v.style.opacity=0.6; v.style.cursor='not-allowed';
    } else {
      const v = item.querySelector('.btn-verify');
      v.disabled = true; v.textContent='Verify'; v.style.opacity=1; v.style.cursor='not-allowed'; v.style.background='#cfd8dc';
    }
  });
  updateAdUIandBalance();
});

/* initial UI: if tasks done cookie, set verify disabled */
window.dispatchEvent(new Event('focus'));
</script>

</body>
</html>
